# 支付流程测试文档

## 测试目标
验证完整的支付流程和 Telegram 通知功能是否正常工作。

## 前置条件

### 1. 配置 Telegram Bot Chat ID

**当前状态**：
- Bot Token: `8292869671:AAES2qE5-r5O0eHZ30IE0AQ2GC4ArcxXyqk` ✅ 有效
- Chat ID: `7293658714` ❌ 返回 "chat not found"

**获取正确 Chat ID 的步骤**：

1. 在 Telegram 中搜索 Bot（使用 @BotFather 查询 Bot 用户名）
2. 向 Bot 发送 `/start` 命令或任意消息
3. 运行以下命令获取 Chat ID：
   ```bash
   curl -s "https://api.telegram.org/bot8292869671:AAES2qE5-r5O0eHZ30IE0AQ2GC4ArcxXyqk/getUpdates" | grep -o '"chat":{"id":[0-9]*' | grep -o '[0-9]*'
   ```
4. 将获取到的 Chat ID 更新到 `server/telegram.ts` 第 10 行：
   ```typescript
   const TELEGRAM_CHAT_ID = "YOUR_CHAT_ID";
   ```

## 测试步骤

### 步骤 1: 注册测试账号

1. 访问注册页面：`https://3000-xxx.manus.computer/register`
2. 输入测试邮箱（建议使用真实邮箱以接收验证码）
3. 点击"发送验证码"按钮
4. 检查邮箱收到验证码（主题：Log VPN - 注册验证码）
5. 输入验证码、设置密码、确认密码
6. 点击"注册"按钮
7. **预期结果**：注册成功，跳转到首页

### 步骤 2: 登录并访问充值页面

1. 使用 Manus OAuth 登录（点击"登录"按钮）
2. 登录成功后，访问充值页面：`https://3000-xxx.manus.computer/recharge`
3. **预期结果**：看到套餐列表（免费体验版、无限尊享版）

### 步骤 3: 选择套餐并上传支付凭证

1. 选择"无限尊享版"套餐（¥199）
2. 点击"立即购买"按钮
3. 在支付弹窗中查看收款码
4. 上传支付凭证截图（任意图片即可用于测试）
5. 点击"提交凭证"按钮
6. **预期结果**：
   - 前端显示"支付凭证已提交，请等待审核"
   - 后端日志显示 Telegram 通知发送成功/失败

### 步骤 4: 验证 Telegram 通知

1. 检查您的 Telegram 是否收到通知
2. **预期通知内容**：
   ```
   💰 付费成功通知

   用户 test@example.com 已成功购买套餐

   📦 套餐：无限尊享版
   💵 金额：¥199
   📝 订单号：PROOF-123

   请及时审核并激活订阅：
   [点击进入审核中心]
   ```

### 步骤 5: 管理员审核（可选）

1. 访问管理员审核中心：`https://3000-xxx.manus.computer/admin/review`
2. 查看待审核的支付凭证
3. 点击"通过"按钮激活订阅
4. **预期结果**：
   - 用户订阅状态更新为"已激活"
   - 用户收到订阅激活确认邮件

## 测试检查清单

- [ ] 验证码邮件发送成功
- [ ] 注册流程完成
- [ ] 登录成功
- [ ] 充值页面显示正常
- [ ] 支付凭证上传成功
- [ ] Telegram 通知发送成功
- [ ] 通知内容正确（用户邮箱、套餐、金额、订单号）
- [ ] 审核链接可用
- [ ] 管理员可以审核并激活订阅

## 故障排查

### Telegram 通知未收到

**可能原因**：
1. Chat ID 不正确
2. Bot Token 失效
3. 网络连接问题

**解决方法**：
1. 按照"前置条件"部分重新获取 Chat ID
2. 检查 `server/telegram.ts` 配置是否正确
3. 查看后端日志确认错误信息

### 验证码邮件未收到

**可能原因**：
1. 邮件被归类为垃圾邮件
2. SMTP 配置错误
3. 邮箱地址输入错误

**解决方法**：
1. 检查垃圾邮件文件夹
2. 验证 `server/email.ts` 中的 SMTP 配置
3. 重新输入邮箱地址并再次发送

## 测试结果记录

**测试日期**：_____________

**测试人员**：_____________

**测试结果**：
- 注册流程：✅ / ❌
- 支付凭证上传：✅ / ❌
- Telegram 通知：✅ / ❌
- 管理员审核：✅ / ❌

**备注**：
_______________________________________________
_______________________________________________
_______________________________________________
