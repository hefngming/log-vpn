name: Create Release

on:
  push:
    tags:
      - 'v*' # å½“æ¨é€ v* æ ¼å¼çš„ tag æ—¶è§¦å‘ï¼ˆä¾‹å¦‚ v1.0.0ï¼‰

permissions:
  contents: write # éœ€è¦å†™æƒé™æ¥åˆ›å»º Release

jobs:
  build-and-release:
    runs-on: windows-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build App
        run: pnpm run build

      - name: Package with Electron Builder
        run: pnpm run package
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Get version from tag
        id: get_version
        shell: bash
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Calculate checksums
        id: checksums
        shell: bash
        run: |
          cd release
          EXE_FILE=$(ls *.exe | head -n 1)
          echo "EXE_FILE=$EXE_FILE" >> $GITHUB_OUTPUT
          
          # è®¡ç®— MD5
          MD5_HASH=$(md5sum "$EXE_FILE" | awk '{print $1}')
          echo "MD5=$MD5_HASH" >> $GITHUB_OUTPUT
          
          # è®¡ç®— SHA256
          SHA256_HASH=$(sha256sum "$EXE_FILE" | awk '{print $1}')
          echo "SHA256=$SHA256_HASH" >> $GITHUB_OUTPUT
          
          # è·å–æ–‡ä»¶å¤§å°ï¼ˆMBï¼‰
          FILE_SIZE=$(du -m "$EXE_FILE" | awk '{print $1}')
          echo "SIZE=$FILE_SIZE" >> $GITHUB_OUTPUT

      - name: Create Release Notes
        id: release_notes
        shell: bash
        run: |
          cat << EOF > release_notes.md
          ## ğŸ‰ LogVPN Windows å®¢æˆ·ç«¯ v${{ steps.get_version.outputs.VERSION }}

          ### âœ¨ ä¸»è¦ç‰¹æ€§
          - âœ… ç´«è‰²ç›¾ç‰Œåº”ç”¨å›¾æ ‡
          - âœ… Sentry é”™è¯¯ç›‘æ§é›†æˆ
          - âœ… æ”¯æŒ VLESSã€Trojanã€Shadowsocks ç­‰å¤šç§åè®®
          - âœ… ç®€æ´æ˜“ç”¨çš„ç”¨æˆ·ç•Œé¢
          - âœ… æ™ºèƒ½è·¯å¾„åŠ è½½æœºåˆ¶

          ### ğŸ“¥ ä¸‹è½½
          - **Windows 64ä½**ï¼š${{ steps.checksums.outputs.EXE_FILE }}

          ### ğŸ”’ æ–‡ä»¶æ ¡éªŒ
          - **æ–‡ä»¶å¤§å°**ï¼š${{ steps.checksums.outputs.SIZE }} MB
          - **MD5**ï¼š\`${{ steps.checksums.outputs.MD5 }}\`
          - **SHA256**ï¼š\`${{ steps.checksums.outputs.SHA256 }}\`

          ### ğŸ“ ç³»ç»Ÿè¦æ±‚
          - Windows 10/11 (64ä½)
          - .NET Framework 4.7.2 æˆ–æ›´é«˜ç‰ˆæœ¬

          ### âš ï¸ å®‰å…¨æç¤º
          Windows SmartScreen å¯èƒ½æ˜¾ç¤ºå®‰å…¨è­¦å‘Šï¼ˆå› ä¸ºå°šæœªè´­ä¹°ä»£ç ç­¾åè¯ä¹¦ï¼‰ã€‚
          
          **è§£å†³æ–¹æ³•**ï¼š
          1. ç‚¹å‡»"æ›´å¤šä¿¡æ¯"
          2. ç‚¹å‡»"ä»è¦è¿è¡Œ"
          3. æˆ–è€…éªŒè¯ä¸Šè¿° SHA256 æ ¡éªŒå’Œç¡®ä¿æ–‡ä»¶å®Œæ•´æ€§

          ### ğŸ› å·²çŸ¥é—®é¢˜
          - é¦–æ¬¡å¯åŠ¨å¯èƒ½éœ€è¦ 5-10 ç§’åŠ è½½æ—¶é—´
          - å¦‚é‡åˆ°é—®é¢˜ï¼Œè¯·æŸ¥çœ‹æ—¥å¿—æ–‡ä»¶ï¼š\`%APPDATA%\LogVPN\logs\`

          ### ğŸ“ æ”¯æŒ
          - é—®é¢˜åé¦ˆï¼šhttps://github.com/hefngming/log-vpn/issues
          - ä½¿ç”¨æ–‡æ¡£ï¼šhttps://dj.siumingho.dpdns.org
          EOF

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          name: LogVPN v${{ steps.get_version.outputs.VERSION }}
          body_path: release_notes.md
          files: |
            release/*.exe
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload Build Artifacts (Backup)
        uses: actions/upload-artifact@v4
        with:
          name: LogVPN-Windows-Installer-v${{ steps.get_version.outputs.VERSION }}
          path: release/*.exe
          if-no-files-found: error
