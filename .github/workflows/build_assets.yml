name: Build Assets

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  build:
    name: Build ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [windows-latest, macos-latest]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install pnpm
        uses: pnpm/action-setup@v4

      # 核心修复：在构建前动态补全 package.json 关键字段
      - name: Fix package.json for Electron
        shell: bash
        run: |
          node -e "
          const fs = require('fs');
          const pkg = JSON.parse(fs.readFileSync('package.json', 'utf8'));
          pkg.description = 'LogVPN Official Client';
          pkg.author = 'LogVPN';
          pkg.main = 'client-src/main.ts';
          pkg.build = {
            appId: 'com.logvpn.official',
            productName: 'LogVPN',
            directories: { output: 'dist_electron' },
            win: { target: 'nsis' },
            mac: { target: 'dmg' },
            files: ['dist/**/*', 'client-src/**/*', 'resources/**/*']
          };
          fs.writeFileSync('package.json', JSON.stringify(pkg, null, 2));
          "

      - name: Install Dependencies
        run: |
          pnpm install
          pnpm add -D electron electron-builder tsx

      - name: Build Frontend
        run: pnpm run build

      - name: Download v2ray Core
        shell: pwsh
        run: |
          $dest = "resources/v2ray"
          if (!(Test-Path $dest)) { New-Item -ItemType Directory -Force -Path $dest }
          $url = if ('${{ matrix.os }}' -eq 'windows-latest') { 'https://github.com/v2fly/v2ray-core/releases/download/v5.14.1/v2ray-windows-64.zip' } else { 'https://github.com/v2fly/v2ray-core/releases/download/v5.14.1/v2ray-macos-64.zip' }
          Invoke-WebRequest -Uri $url -OutFile v2ray.zip
          Expand-Archive -Path v2ray.zip -DestinationPath $dest -Force

      - name: Build Electron App
        run: npx electron-builder --${{ matrix.os == 'windows-latest' && 'win' || 'mac' }} --x64
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          NODE_OPTIONS: "--max-old-space-size=4096"

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: LogVPN-${{ matrix.os }}
          path: dist_electron/*.${{ matrix.os == 'windows-latest' && 'exe' || 'dmg' }}
