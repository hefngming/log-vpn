name: Build and Release LogVPN Client

on:
  push:
    branches: [ main, develop ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., 1.0.0)'
        required: false
        default: ''

env:
  DOTNET_VERSION: '4.8'
  NSIS_VERSION: '3.x'
  MSBUILD_PATH: 'C:\Program Files\Microsoft Visual Studio\2022\Community\MSBuild\Current\Bin\MSBuild.exe'

jobs:
  build:
    name: Build LogVPN Client
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      with:
        submodules: recursive
    
    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v1
      with:
        vs-version: '17.x'
    
    - name: Setup NuGet
      uses: NuGet/setup-nuget@v1
      with:
        nuget-version: '6.x'
    
    - name: Restore NuGet packages
      run: nuget restore v2rayN/v2rayN.sln
    
    - name: Build solution (Release x64)
      run: |
        msbuild v2rayN/v2rayN.sln `
          /p:Configuration=Release `
          /p:Platform=x64 `
          /p:DebugType=none `
          /m
    
    - name: Verify build output
      run: |
        $outputDir = "v2rayN\bin\Release\x64"
        if (-not (Test-Path $outputDir)) {
          Write-Error "Build output directory not found: $outputDir"
          exit 1
        }
        
        $requiredFiles = @("v2rayN.exe", "v2rayN.exe.config", "v2rayUpgrade.exe")
        foreach ($file in $requiredFiles) {
          $filePath = Join-Path $outputDir $file
          if (-not (Test-Path $filePath)) {
            Write-Error "Required file not found: $file"
            exit 1
          }
          Write-Host "✓ Found $file"
        }
    
    - name: Install NSIS
      run: choco install nsis -y
    
    - name: Build installer
      run: |
        $nsisPath = "C:\Program Files (x86)\NSIS\makensis.exe"
        & $nsisPath LogVPN_Installer.nsi
        
        if ($LASTEXITCODE -ne 0) {
          Write-Error "NSIS build failed"
          exit 1
        }
    
    - name: Verify installer
      run: |
        if (-not (Test-Path "LogVPN_Setup.exe")) {
          Write-Error "Installer file not found"
          exit 1
        }
        
        $fileSize = (Get-Item "LogVPN_Setup.exe").Length / 1MB
        $fileMD5 = (Get-FileHash "LogVPN_Setup.exe" -Algorithm MD5).Hash
        $fileSHA256 = (Get-FileHash "LogVPN_Setup.exe" -Algorithm SHA256).Hash
        
        Write-Host "Installer size: $([math]::Round($fileSize, 2)) MB"
        Write-Host "MD5: $fileMD5"
        Write-Host "SHA256: $fileSHA256"
        
        # Save checksums to file
        @{
          filename = "LogVPN_Setup.exe"
          size_mb = [math]::Round($fileSize, 2)
          md5 = $fileMD5
          sha256 = $fileSHA256
          build_time = Get-Date -Format "yyyy-MM-dd HH:mm:ss"
          version = "${{ github.ref_name }}"
        } | ConvertTo-Json | Out-File -FilePath "installer_info.json"
    
    - name: Upload build artifacts
      uses: actions/upload-artifact@v3
      with:
        name: logvpn-installer
        path: |
          LogVPN_Setup.exe
          installer_info.json
        retention-days: 30
    
    - name: Create release
      if: startsWith(github.ref, 'refs/tags/v')
      uses: softprops/action-gh-release@v1
      with:
        files: |
          LogVPN_Setup.exe
          installer_info.json
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  deploy:
    name: Deploy to Server
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/v')
    
    steps:
    - name: Download artifacts
      uses: actions/download-artifact@v3
      with:
        name: logvpn-installer
    
    - name: Setup SSH
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts
    
    - name: Upload to server
      run: |
        scp -i ~/.ssh/id_rsa \
          LogVPN_Setup.exe \
          ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:/home/ubuntu/log-vpn/client/public/downloads/
        
        scp -i ~/.ssh/id_rsa \
          installer_info.json \
          ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:/home/ubuntu/log-vpn/client/public/downloads/version.json
    
    - name: Update download page
      run: |
        ssh -i ~/.ssh/id_rsa ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'EOF'
          cd /home/ubuntu/log-vpn
          
          # Update version.json
          VERSION=$(cat client/public/downloads/version.json | grep -o '"version":"[^"]*' | cut -d'"' -f4)
          echo "Updated LogVPN to version: $VERSION"
          
          # Restart web server if needed
          # systemctl restart nginx
        EOF
    
    - name: Notify deployment
      if: always()
      run: |
        echo "Deployment status: ${{ job.status }}"
        echo "Installer uploaded to: https://${{ secrets.SERVER_HOST }}/downloads/LogVPN_Setup.exe"

  test:
    name: Run Tests
    runs-on: windows-latest
    needs: build
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Download installer
      uses: actions/download-artifact@v3
      with:
        name: logvpn-installer
    
    - name: Verify installer integrity
      run: |
        $expectedMD5 = (Get-Content installer_info.json | ConvertFrom-Json).md5
        $actualMD5 = (Get-FileHash "LogVPN_Setup.exe" -Algorithm MD5).Hash
        
        if ($expectedMD5 -ne $actualMD5) {
          Write-Error "MD5 mismatch! Expected: $expectedMD5, Got: $actualMD5"
          exit 1
        }
        
        Write-Host "✓ Installer integrity verified"
    
    - name: Test installer execution
      run: |
        # Extract installer to test directory
        $testDir = "C:\LogVPN_Test"
        New-Item -ItemType Directory -Path $testDir -Force
        
        # Run installer in silent mode
        & "LogVPN_Setup.exe" /S /D=$testDir
        
        # Check if installation was successful
        if (Test-Path "$testDir\v2rayN.exe") {
          Write-Host "✓ Installation test passed"
        } else {
          Write-Error "Installation test failed"
          exit 1
        }
