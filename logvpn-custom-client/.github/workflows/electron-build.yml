name: Electron Build and Release

on:
  push:
    branches:
      - main
      - develop
    tags:
      - 'v*'
  pull_request:
    branches:
      - main
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    
    strategy:
      matrix:
        node-version: [18.x]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Build TypeScript
        run: npm run build
        env:
          NODE_ENV: production
      
      - name: Verify dist directory
        run: |
          if (!(Test-Path "dist")) {
            Write-Error "dist directory not found after build"
            exit 1
          }
          if (!(Test-Path "dist/main.js")) {
            Write-Error "dist/main.js not found"
            exit 1
          }
          Write-Host "✓ dist directory verified"
          Write-Host "✓ dist/main.js verified"
          Get-ChildItem -Path "dist" -Recurse | Measure-Object | Select-Object -ExpandProperty Count | Write-Host "Files in dist:"
      
      - name: Build Electron app
        run: npm run dist:win
        env:
          NODE_ENV: production
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Verify build output
        run: |
          if (!(Test-Path "dist/LogVPN_Setup.exe")) {
            Write-Error "LogVPN_Setup.exe not found"
            exit 1
          }
          $fileSize = (Get-Item "dist/LogVPN_Setup.exe").Length / 1MB
          Write-Host "✓ LogVPN_Setup.exe created"
          Write-Host "File size: $fileSize MB"
          
          if ($fileSize -lt 100) {
            Write-Warning "Warning: File size is smaller than expected (< 100 MB)"
          }
      
      - name: Calculate checksums
        run: |
          $file = "dist/LogVPN_Setup.exe"
          $md5 = (Get-FileHash -Path $file -Algorithm MD5).Hash
          $sha256 = (Get-FileHash -Path $file -Algorithm SHA256).Hash
          
          Write-Host "MD5: $md5" | Out-File -FilePath "dist/checksums.txt" -Encoding UTF8
          Write-Host "SHA256: $sha256" | Out-File -FilePath "dist/checksums.txt" -Encoding UTF8 -Append
          
          Write-Host "MD5: $md5"
          Write-Host "SHA256: $sha256"
      
      - name: Upload artifact
        uses: actions/upload-artifact@v3
        with:
          name: logvpn-setup
          path: |
            dist/LogVPN_Setup.exe
            dist/checksums.txt
          retention-days: 30
      
      - name: Create Release
        if: startsWith(github.ref, 'refs/tags/v')
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref }}
          release_name: Release ${{ github.ref }}
          draft: false
          prerelease: false
      
      - name: Upload Release Asset
        if: startsWith(github.ref, 'refs/tags/v')
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ./dist/LogVPN_Setup.exe
          asset_name: LogVPN_Setup.exe
          asset_content_type: application/octet-stream
      
      - name: Deploy to server
        if: github.ref == 'refs/heads/main'
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: "dist/LogVPN_Setup.exe"
          target: "/home/ubuntu/log-vpn/client/public/downloads/"
          strip_components: 1
      
      - name: Notify deployment
        if: github.ref == 'refs/heads/main'
        run: |
          Write-Host "✓ Build completed successfully"
          Write-Host "✓ Installer uploaded to server"
          Write-Host "✓ Download URL: https://dj.siumingho.dpdns.org/downloads/LogVPN_Setup.exe"
